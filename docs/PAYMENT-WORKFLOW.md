# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

> **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-10-22
> **–í–µ—Ä—Å–∏—è:** 2.0
> **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∏–π –æ–±–∑–æ—Ä](#–æ–±—â–∏–π-–æ–±–∑–æ—Ä)
2. [–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞](#—Å–æ–∑–¥–∞–Ω–∏–µ-–ø–ª–∞—Ç–µ–∂–∞)
3. [–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ](#–ø—Ä–æ–≤–µ—Ä–∫–∞-–∏-–∑–∞—á–∏—Å–ª–µ–Ω–∏–µ)
4. [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ-—Å–ø–∏—Å–∞–Ω–∏–µ)
5. [–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
6. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## –û–±—â–∏–π –æ–±–∑–æ—Ä

–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö:
- **Strategy Pattern** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
- **Scheduled Tasks** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–ø–∏—Å–∞–Ω–∏–µ
- **Audit Trail** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
- **Idempotency** - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ **YooMoney** (–±—ã–≤—à–∏–π –Ø–Ω–¥–µ–∫—Å.–î–µ–Ω—å–≥–∏):
- –ü—Ä–∏—ë–º –ø–ª–∞—Ç–µ–∂–µ–π —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∫–∞—Ä—Ç (Visa, MasterCard, –ú–ò–†)
- Webhook-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- SHA1 –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

---

## –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π flow

```
START ‚Üí HOME ‚Üí GET_ACCESS ‚Üí –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ ‚Üí PAYMENT ‚Üí –û–ø–ª–∞—Ç–∞
```

### –®–∞–≥ 1: –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞

**–§–∞–π–ª—ã:**
- [month-tariff.conversation.ts](../src/grammy/conversations/month-tariff.conversation.ts)
- [threemonth-tariff.conversation.ts](../src/grammy/conversations/threemonth-tariff.conversation.ts)
- [sixmonth-tariff.conversation.ts](../src/grammy/conversations/sixmonth-tariff.conversation.ts)

```typescript
// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –≤ session
ctx.session.tariffId = 'MONTH_TARIFF';
await conversation.external(() =>
  ctx.conversation.enter(CommandEnum.PAYMENT)
);
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**–§–∞–π–ª:** [payment.conversation.ts](../src/grammy/conversations/payment.conversation.ts)

```typescript
const payment = await paymentService.createPayment(
  userId,
  chatId,
  ctx.session.tariffId,
  PaymentSystemEnum.YOOMONEY
);

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
await ctx.reply(
  `üí≥ –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: ${process.env.DOMAIN}/payment/${payment.paymentId}`,
  { parse_mode: 'HTML' }
);
```

### –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Ñ–æ—Ä–º—ã

**–§–∞–π–ª:** [payment.service.ts](../src/payment/payment.service.ts)

```typescript
async createPayment(
  userId: number,
  chatId: number,
  tariffId: string,
  paymentSystem: PaymentSystemEnum
): Promise<Payment> {
  // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–∞—Ä–∏—Ñ–∞
  const user = await this.userService.findOneByUserId(userId);
  const tariff = await this.tariffService.getOneById(tariffId);

  // 2. –ò—Å–ø–æ–ª—å–∑—É–µ–º Strategy Pattern
  const strategy = this.paymentStrategyFactory
    .createPaymentStrategy(paymentSystem);

  // 3. –°–æ–∑–¥–∞—ë–º –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
  const payment = await strategy.createPayment({
    userId,
    chatId,
    tariffId,
    tariffPrice: tariff.price,
    paymentAt: DateTime.local().toJSDate(),
  });

  // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PENDING
  return this.prisma.payment.create({ data: payment._payment });
}
```

### –®–∞–≥ 4: YooMoney Strategy

**–§–∞–π–ª:** [yoomoney-payment.strategy.ts](../src/payment/strategies/yoomoney-payment.strategy.ts)

```typescript
async createPayment(data: CreatePaymentData): Promise<PaymentProxy> {
  const paymentId = uuidv4();

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Ñ–æ—Ä–º—ã –¥–ª—è YooMoney
  const form = this.generatePaymentForm(paymentId, data.tariffPrice);

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è redirect URL
  const url = `${this.domain}/payment/${paymentId}`;

  return {
    _payment: {
      paymentId,
      orderId: paymentId,
      status: PaymentStatusEnum.PENDING,
      paymentSystem: PaymentSystemEnum.YOOMONEY,
      userId: data.userId,
      chatId: data.chatId,
      tariffId: data.tariffId,
      amount: data.tariffPrice,
      paymentAt: data.paymentAt,
      paymentAmount: data.tariffPrice,
      paymentCurrency: 'RUB',
      url,
      form,
    }
  };
}
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ

### –ú–µ—Ç–æ–¥ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (Scheduler)

**–§–∞–π–ª:** [payment.scheduler.ts](../src/payment/payment.scheduler.ts)

```typescript
@Cron(CronExpression.EVERY_10_SECONDS)
async handlePendingPayments() {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PENDING
  const pendingPayments = await this.paymentService.getPendingPayments();

  for (const payment of pendingPayments) {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å (–≤–∫–ª—é—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
        await this.paymentService.validatePayment(payment.paymentId);
    } catch (e) {
        // Log error
    }
  }
}
```

### –ú–µ—Ç–æ–¥ 2: Webhook –æ—Ç YooMoney

**–§–∞–π–ª:** [payment.controller.ts](../src/payment/payment.controller.ts)

```typescript
@Post('yoomoney/notification')
async yooMoneyNotification(@Body() notification: YooMoneyNotification) {
  const isValid = await this.paymentService.yooMoneyWebHook(notification);
  return { success: isValid };
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è webhook:** [payment.service.ts](../src/payment/payment.service.ts)

```typescript
async yooMoneyWebHook(notification: YooMoneyNotification): Promise<boolean> {
  const secret = this.configService.get('YOOMONEY_SECRET');

  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ SHA1 –ø–æ–¥–ø–∏—Å–∏
  const hashString = [
    notification.notification_type,
    notification.operation_id,
    notification.amount,
    notification.currency,
    notification.datetime,
    notification.sender,
    notification.codepro,
    secret,
    notification.label,
  ].join('&');

  const calculatedHash = createHash('sha1')
    .update(hashString)
    .digest('hex');

  if (calculatedHash !== notification.sha1_hash) {
    return false; // –ü–æ–¥–ø–∏—Å—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
  }

  // 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API
  const operationDetails = await this.yooMoney.getOperationDetails(
    notification.operation_id
  );

  if (
    operationDetails.operation_id === notification.operation_id &&
    operationDetails.amount === parseFloat(notification.amount) &&
    operationDetails.sender === notification.sender &&
    operationDetails.label === notification.label
  ) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
    await this.updatePaymentStatus(
      notification.label,
      PaymentStatusEnum.PAID,
      true
    );
    return true;
  }

  return false;
}
```

### –õ–æ–≥–∏–∫–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

**–§–∞–π–ª:** [payment.service.ts](../src/payment/payment.service.ts)

```typescript
async validatePayment(paymentId: string): Promise<boolean> {
  const payment = await this.findPaymentByPaymentId(paymentId);

  const strategy = this.paymentStrategyFactory
    .createPaymentStrategy(PaymentSystemEnum[payment.paymentSystem]);

  const paymentStatus = await strategy.validateTransaction(payment.paymentId);
  const isPaid = paymentStatus === PaymentStatusEnum.PAID;

  if (isPaid) {
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–∞–Ω—Å –¢–û–õ–¨–ö–û –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
    if (paymentStatus !== payment.status) {
      const user = await this.userService.findOneByUserId(payment.userId);
      const tariff = await this.tariffService.getOneById(payment.tariffId);

      if (user) {
        await this.userService.commitBalanceChange(
          user,
          tariff.price,
          BalanceChangeTypeEnum.PAYMENT,
          paymentId
        );
      }
    }

    await this.updatePaymentStatus(paymentId, PaymentStatusEnum.PAID, isPaid);
  }

  return isPaid;
}
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ validatePayment:
if (paymentStatus !== payment.status) {
  // –ó–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–∞–Ω—Å –¢–û–õ–¨–ö–û –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ PAID
  await this.userService.commitBalanceChange(...);
}
```

**–§–∞–π–ª:** [user.service.ts](../src/user/user.service.ts)

```typescript
async commitBalanceChange(
  user: User,
  change: number,
  type: BalanceChangeTypeEnum,
  paymentId?: string
): Promise<BalanceChange> {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
  const status: BalanceChangeStatusEnum =
    (user.balance + change) <= 0
      ? BalanceChangeStatusEnum.INSUFFICIENT
      : BalanceChangeStatusEnum.DONE;

  // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ BalanceChange (audit trail)
  const balanceEntry = {
    userId: user.userId,
    changeAmount: change,
    paymentId: paymentId,
    balance: user.balance,
    type: BalanceChangeTypeEnum[type],
    status: status,
  };

  return this.prisma.balanceChange.create({ data: balanceEntry })
    .then(async balanceChange => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å = DONE
      if (status == BalanceChangeStatusEnum.DONE) {
        await this.updateUser({
          where: { userId: user.userId },
          data: {
            balance: user.balance + balanceChange.changeAmount
          }
        });
      }
      return balanceChange;
    });
}
```

---

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

### –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

**–§–∞–π–ª:** [payment.scheduler.ts](../src/payment/payment.scheduler.ts)

```typescript
@Cron(CronExpression.EVERY_DAY_AT_MIDNIGHT)
async handleMidnight() {
  const serviceFee = this.botService.minimumBalance; // –∏–∑ .env

  // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–∞–ª–∞–Ω—Å–æ–º >= serviceFee
  const users = await this.userService.usersWithBalance(serviceFee);

  for (const user of users) {
    const balanceChange = await this.userService.commitBalanceChange(
      user,
      -serviceFee, // –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = —Å–ø–∏—Å–∞–Ω–∏–µ
      BalanceChangeTypeEnum.SCHEDULER
    );

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω
    if (balanceChange.status == BalanceChangeStatusEnum.INSUFFICIENT) {
      await this.botService.sendInsufficientChargeMessage(
        user.chatId,
        user.balance,
        balanceChange.changeAmount
      );
    }
  }
}
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```env
MINIMUM_BALANCE=3  # –°—É–º–º–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –≤ —Ä—É–±–ª—è—Ö
```

---

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### 1. –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)

**–§–∞–π–ª:** [bot.service.ts](../src/grammy/bot.service.ts)

```typescript
async sendPaymentSuccessMessage(
  chatId: number,
  balance: number
): Promise<void> {
  const balanceFormatted = balance.toLocaleString('ru-RU', {
    style: 'currency',
    currency: 'RUB',
  });

  await this.sendMessage(
    chatId,
    `‚úÖ –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω!\nüí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balanceFormatted}`
  );
}
```

### 2. –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–∞–¥–º–∏–Ω–∞–º)

```typescript
### 2. –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–∞–¥–º–∏–Ω–∞–º)

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü–∞ `AdminUser`) —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º `telegramId`.

**–§–∞–π–ª:** [payment.service.ts](../src/payment/payment.service.ts)

```typescript
private async notifyAdmins(transaction: Transaction, username: string) {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤
  const admins = await this.prisma.adminUser.findMany({
    where: { telegramId: { not: null } }
  });

  const message = `üí∞ <b>–ù–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞!</b>\n...`;

  for (const admin of admins) {
     // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω—É
     await this.grammyService.bot.api.sendMessage(Number(admin.telegramId), message, { parse_mode: 'HTML' });
  }
}
```

### 3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å

```typescript
async sendInsufficientChargeMessage(
  chatId: number,
  balance: number,
  change: number
): Promise<void> {
  const balanceCurrency = balance.toLocaleString('ru-RU', {
    style: 'currency',
    currency: 'RUB',
  });
  const changeCurrency = Math.abs(change).toLocaleString('ru-RU', {
    style: 'currency',
    currency: 'RUB',
  });

  await this.sendMessage(
    chatId,
    `‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è ${changeCurrency}\n\n` +
    `üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balanceCurrency}\n` +
    `üí≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å`
  );
}
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Strategy Pattern

```
PaymentService
    ‚Üì
PaymentStrategyFactory
    ‚Üì
PaymentStrategy (interface)
    ‚îú‚îÄ‚îÄ YooMoneyPaymentStrategy
    ‚îú‚îÄ‚îÄ (Future) StripePaymentStrategy
    ‚îî‚îÄ‚îÄ (Future) CryptoPaymentStrategy
```

### Database Models

```prisma
// –ü–ª–∞—Ç—ë–∂
model Payment {
  paymentId       String   @id        // UUID –ø–ª–∞—Ç–µ–∂–∞
  status          String              // PENDING | PAID | FAILED | CANCELED
  paymentSystem   String              // YOOMONEY | ...
  userId          Int                 // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  tariffId        String              // ID —Ç–∞—Ä–∏—Ñ–∞
  amount          Int                 // –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
  paymentAt       DateTime            // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
  transactionId   String?             // ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
  // ...
}

// –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
model BalanceChange {
  id           Int      @id
  userId       Int                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  paymentId    String?                // –°–≤—è–∑—å —Å –ø–ª–∞—Ç–µ–∂–æ–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
  balance      Int                    // –ë–∞–ª–∞–Ω—Å –î–û –∏–∑–º–µ–Ω–µ–Ω–∏—è
  changeAmount Int                    // –°—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (+/-)
  type         String                 // PAYMENT | MANUALLY | SCHEDULER
  status       String                 // DONE | INSUFFICIENT
  changeAt     DateTime               // Timestamp
}
```

### Cron Schedule

| Task | Schedule | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|----------|------------|
| `handlePendingPayments()` | –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ pending –ø–ª–∞—Ç–µ–∂–µ–π |
| `handleMidnight()` | –ö–∞–∂–¥—É—é –ø–æ–ª–Ω–æ—á—å | –°–ø–∏—Å–∞–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞—Ç—ã |

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã

1. **SHA1 –≤–∞–ª–∏–¥–∞—Ü–∏—è webhook**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç YooMoney
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

2. **–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞**
   - Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API YooMoney

3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
   - Idempotency key (paymentId)

4. **Audit trail**
   - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤ BalanceChange
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –¥–æ –∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

5. **Admin-only –æ–ø–µ—Ä–∞—Ü–∏–∏**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ ADMIN_CHAT_ID –¥–ª—è –∫–æ–º–∞–Ω–¥ `/up` –∏ `/tariff`

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **Rate limiting** –¥–ª—è webhook endpoints
2. **IP whitelist** –¥–ª—è YooMoney webhook
3. **Monitoring** –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
4. **Alerts** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞—á–∏—Å–ª–µ–Ω–∏—è

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–ª–Ω–æ–≥–æ flow

```mermaid
graph TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ] --> B[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ tariffId –≤ session]
    B --> C[PaymentService.createPayment]
    C --> D[YooMoneyStrategy.createPayment]
    D --> E[–°–æ–∑–¥–∞–Ω–∏–µ Payment –≤ –ë–î status=PENDING]
    E --> F[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –æ–ø–ª–∞—Ç—ã]
    F --> G[–û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Å—ã–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]

    G --> H{–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ YooMoney}

    H --> I[Webhook –æ—Ç YooMoney]
    I --> J[–í–∞–ª–∏–¥–∞—Ü–∏—è SHA1]
    J --> K[–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API]
    K --> L[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí PAID]

    H --> M[PaymentScheduler –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫]
    M --> N[validatePayment]
    N --> O{–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è?}

    O -->|–î–∞| P[commitBalanceChange]
    P --> Q[–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞]
    Q --> R[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    Q --> S[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É]

    O -->|–ù–µ—Ç| T[–ü—Ä–æ–ø—É—Å–∫ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è]

    style Q fill:#90EE90
    style R fill:#87CEEB
    style S fill:#87CEEB
```

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### Core Services
- [payment.service.ts](../src/payment/payment.service.ts) - –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π
- [user.service.ts](../src/user/user.service.ts) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º
- [tariff.service.ts](../src/tariff/tariff.service.ts) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞–º–∏

### Strategies
- [payment-strategy.interface.ts](../src/payment/strategies/payment-strategy.interface.ts)
- [yoomoney-payment.strategy.ts](../src/payment/strategies/yoomoney-payment.strategy.ts)
- [payment-strategy.factory.ts](../src/payment/strategies/factory/payment-strategy.factory.ts)

### Schedulers
- [payment.scheduler.ts](../src/payment/payment.scheduler.ts)

### Bot
- [bot.service.ts](../src/grammy/bot.service.ts) - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [payment.conversation.ts](../src/grammy/conversations/payment.conversation.ts)
- [get-access.conversation.ts](../src/grammy/conversations/get-access.conversation.ts)
- Tariff conversations: month-tariff, threemonth-tariff, sixmonth-tariff

### Controllers
- [payment.controller.ts](../src/payment/payment.controller.ts) - Webhook endpoint

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# YooMoney
YOOMONEY_SECRET=your_yoomoney_secret_key
YOOMONEY_SUCCESS_URL=https://your-domain.com/payment/success

# –ê–¥–º–∏–Ω—ã
ADMIN_CHAT_ID=123456789
ADMIN_CHAT_ID_2=987654321

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
MINIMUM_BALANCE=3
DOMAIN=https://your-domain.com
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º best practices:

‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –¥–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤–∞–ª–∏–¥–∞—Ü–∏—è webhook, –∑–∞—â–∏—Ç–∞ –æ—Ç replay attacks
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - Strategy Pattern –¥–ª—è –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ø–æ–ª–Ω—ã–π audit trail –≤ BalanceChange
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - cron jobs –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Å–ø–∏—Å–∞–Ω–∏—è

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.
