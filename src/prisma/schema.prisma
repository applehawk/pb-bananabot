generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  telegramId        BigInt        @unique
  username          String?
  firstName         String?
  lastName          String?
  languageCode      String        @default("en")
  credits           Float         @default(0)
  freeCreditsUsed   Int           @default(0)
  totalGenerated    Int           @default(0)
  referralCode      String        @unique
  referredBy        String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastActiveAt      DateTime      @default(now())
  dailyBonus        DailyBonus?
  generations       Generation[]
  referralsReceived Referral[]    @relation("Referred")
  referralsGiven    Referral[]    @relation("Referrer")
  transactions      Transaction[]
  settings          UserSettings?

  @@index([telegramId])
  @@index([referralCode])
  @@index([createdAt])
}

model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  aspectRatio       String   @default("1:1")
  numberOfImages    Int      @default(1)
  safetyLevel       String   @default("BLOCK_MEDIUM_AND_ABOVE")
  language          String   @default("en")
  hdQuality         Boolean  @default(false)
  autoEnhance       Boolean  @default(true)
  useNegativePrompt Boolean  @default(true)
  notifyOnComplete  Boolean  @default(true)
  notifyOnBonus     Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Generation {
  id             String           @id @default(cuid())
  userId         String
  type           GenerationType
  prompt         String
  negativePrompt String?
  enhancedPrompt String?
  aspectRatio    String           @default("1:1")
  numberOfImages Int              @default(1)
  safetyLevel    String
  imageUrl       String?
  fileId         String?
  thumbnailUrl   String?
  status         GenerationStatus @default(PENDING)
  creditsUsed    Float
  errorMessage   String?
  metadata       Json?
  processingTime Int?
  createdAt      DateTime         @default(now())
  completedAt    DateTime?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  inputImages    InputImage[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
}

model InputImage {
  id           String     @id @default(cuid())
  generationId String
  fileId       String
  fileUrl      String?
  order        Int
  createdAt    DateTime   @default(now())
  generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)

  @@index([generationId])
  @@index([order])
}

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  type          TransactionType
  amount        Float?
  creditsAdded  Float
  paymentMethod PaymentMethod     @default(FREE)
  paymentId     String?
  currency      String?           @default("USD")
  status        TransactionStatus @default(PENDING)
  metadata      Json?
  description   String?
  createdAt     DateTime          @default(now())
  completedAt   DateTime?
  isFinal       Boolean           @default(false)
  packageId     String?
  package       CreditPackage?    @relation(fields: [packageId], references: [id])
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([paymentId])
  @@index([createdAt])
}

model Referral {
  id                 String   @id @default(cuid())
  referrerId         String
  referredId         String
  bonusGranted       Boolean  @default(false)
  bonusAmount        Float    @default(3)
  firstPurchase      Boolean  @default(false)
  firstPurchaseBonus Float    @default(5)
  createdAt          DateTime @default(now())
  referred           User     @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)
  referrer           User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
  @@index([referrerId])
  @@index([referredId])
}

model DailyBonus {
  id            String    @id @default(cuid())
  userId        String    @unique
  streakDays    Int       @default(0)
  lastClaimDate DateTime?
  totalBonuses  Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastClaimDate])
}

model CreditPackage {
  id            String        @id @default(cuid())
  name          String
  credits       Float
  price         Float
  currency      String        @default("USD")
  discount      Int           @default(0)
  popular       Boolean       @default(false)
  active        Boolean       @default(true)
  priceYooMoney Float?
  priceStars    Int?
  priceCrypto   Float?
  description   String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]

  @@index([active])
  @@index([popular])
}

model AdminUser {
  id         String   @id @default(cuid())
  telegramId BigInt   @unique
  username   String?
  role       String   @default("ADMIN")
  createdAt  DateTime @default(now())

  @@index([telegramId])
}

model Analytics {
  id                    String   @id @default(cuid())
  date                  DateTime @unique @default(now())
  newUsers              Int      @default(0)
  activeUsers           Int      @default(0)
  totalGenerations      Int      @default(0)
  textToImage           Int      @default(0)
  imageToImage          Int      @default(0)
  multiImage            Int      @default(0)
  totalRevenue          Float    @default(0)
  totalCreditsUsed      Float    @default(0)
  totalCreditsPurchased Float    @default(0)
  paymentsYooMoney      Int      @default(0)
  paymentsStars         Int      @default(0)
  paymentsCrypto        Int      @default(0)

  @@index([date])
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  credits     Float
  discount    Int?
  maxUses     Int?
  currentUses Int       @default(0)
  expiresAt   DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([active])
}

model PromoCodeUsage {
  id           String   @id @default(cuid())
  code         String
  userId       String
  creditsGiven Float
  usedAt       DateTime @default(now())

  @@unique([code, userId])
  @@index([userId])
  @@index([code])
}

enum GenerationType {
  TEXT_TO_IMAGE
  IMAGE_TO_IMAGE
  MULTI_IMAGE
  BATCH
}

enum GenerationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionType {
  PURCHASE
  BONUS
  REFERRAL
  DAILY_BONUS
  ADMIN_ADJUSTMENT
  GENERATION_COST
  REFUND
}

enum PaymentMethod {
  YOOMONEY
  TELEGRAM_STARS
  CRYPTO
  FREE
  ADMIN
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
